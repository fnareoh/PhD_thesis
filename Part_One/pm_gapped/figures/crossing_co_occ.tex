 %------------------------------------------------------------ COMMANDS
\newcommand{\rheight}{0.5}
\newcommand{\Alength}{13}
\newcommand{\Aboundary}{7}
\newcommand{\nbB}{6}
\newcommand{\Blength}{1.3}

\newcommand{\nontermA}{
%Non terminal A
\node (ha) at (0,0) {};
\node at (-0.5,0.5*\rheight) {$\str{A}$};
\draw (ha) node[right,shift={(0,{0.5*\rheight})}] {$\str{B}$} rectangle ++ (\Alength,\rheight) node[left, shift={(0,{-0.5*\rheight})}] (ta) {$\str{C}$};

% boundary	
\draw (\Aboundary,0) -- (\Aboundary,\rheight);



% spacing
\draw[white] (0,5*\rheight) -- (\Alength,5*\rheight);
}

\newcommand{\Ponelength}{1.2}
\newcommand{\Ptwolength}{6.4}
\newcommand{\Pheight}{0.1}

\newcommand{\Pone}[2][$i$]{
\node (q1) at (#2) {};
%labels
\path let \p1= (q1) in node (q1label) at (\x1,0) {};
\draw[dotted] ($(q1)$) -- ($(q1label)$) node[below,text height=0.25cm] {\small{#1}};
}

\newcommand{\Ptwo}[2][$j$]{
\node (q2) at (#2) {};
\path let \p1= (q2) in node (q2label) at (\x1,0) {};
\draw[dotted] ($(q2)$) -- ($(q2label)$) node[below,text height=0.25cm] {\small{#1}};
}


\newcommand{\pione}{0.4}


\newcommand{\periods}[2]{
\node (s1) at (#1) {};% start of the run
\foreach \x in {1,...,#2} \draw ($(s1)+(\x*\pione*2,0.2*\rheight)$) arc(0:180:0.4 and \pione);
}

\newcommand{\rectangles}[2]{
\node (s1) at (#1) {};% start of the run
% other p2
\foreach \x in {0,...,#2} \draw[blue] ($(s1)+(\x*\pione*2,-\x*0.7*\rheight)$) -- ($(s1)+(\x*\pione*2,0)+(\Ptwolength,-\x*0.7*\rheight)$);
%preceeding p1
\foreach \x in {1,...,#2}  {
\draw[red] ($(s1)+(\x*\pione*2-0.7,-\x*0.7*\rheight +0.5*\rheight )$) -- ($(s1)+(\x*\pione*2 - 0.7,0)+(\Ponelength,-\x*0.7*\rheight+ 0.5*\rheight)$);
\draw[red] ($(s1)+(\x*\pione*2-0.4,-\x*0.7*\rheight +0.25*\rheight )$) -- ($(s1)+(\x*\pione*2 - 0.4,0)+(\Ponelength,-\x*0.7*\rheight+ 0.25*\rheight)$);
}

\node at($(s1)+ (\pione, 2*\pione)$) {\small{$d$}};
}


%----------------------------------------------------------------------


\centering
\begin{tikzpicture}[scale=0.9, every node/.style={scale=0.8}]
\nontermA
\renewcommand{\rheight}{0.7}
\Ptwo[$j_0$]{3,3.5*\rheight}
\node at (12.1,1.4*\rheight) {$p_2$};
\periods{3,3.5*\rheight}{11}
\rectangles{3,3.5*\rheight}{3}
\Ptwo[$j_0+d$]{3.8,2.8*\rheight}
\Ptwo[$j^\ast$]{5.4,1.4*\rheight}
\Ptwo[$j_0 + \ell \cdot d$]{11.8,1.4*\rheight}
\Pone[$i$]{5,1.6*\rheight}
%\draw[dotted] (3.3,3.15*\rheight) -- (3.3,-\rheight) node[below,text height=0.25cm] {\small{$i+(1-k)d$}};
\node at (6.4,1.6*\rheight) {$p_1$};
\end{tikzpicture}